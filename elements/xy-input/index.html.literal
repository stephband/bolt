
<!DOCTYPE html>
<html lang="en">
<head>
    ${ include('../../templates/head.literal', '../../package.json') }

    <script title="debug">
        window.DEBUG = true;
    </script>
    
    <link rel="stylesheet" href="../../module.css">
    ${ include('../../templates/style.html') }

    <style></style>

    <template id="xy-input-shadow">
        <template id="x-tick">
            <label part="x-tick tick" style="transform: translate(calc($\{ data.up.toViewX(data.tick.value) }em - 50%), 1.5em);">
                <span>$\{ data.tick.label }</span>
            </label>
        </template>

        <template id="y-tick">
            <label part="y-tick tick" style="transform: translate(-2.75em, calc($\{ data.up.toViewY(data.tick.value) }em + 50%));">
                <span>$\{ data.tick.label }</span>
            </label>
        </template>

        <label>
            <slot></slot>
        </label>

        <canvas>$\{
            this.ctx = this.ctx || element.getContext('2d'),
            data.paddingbox && (
                console.log('DRAWWWWW'),

                this.viewbox    = { x: data.contentbox.x * 2, y: data.contentbox.y * 2, width: data.contentbox.width * 2, height: data.contentbox.height * 2 },
                this.computed   = this.computed || getComputedStyle(element),
                this.xGridColor = this.computed.getPropertyValue('--grid-color-x').trim(),
                this.yGridColor = this.computed.getPropertyValue('--grid-color-y').trim(),

                element.width  = data.paddingbox.width * 2,
                element.height = data.paddingbox.height * 2,
                //data.clear(this.ctx, { x: 0, y: 0, width: element.width, height: element.height }),

                data.drawXLines(this.ctx, this.viewbox, data.xaxis
                    .filter((line) => data.valuebox.x + data.valuebox.width >= line.value && line.value >= data.valuebox.x)     
                    .map((line) => ({ x: data.toRatioX(line.value) })),
                    this.xGridColor
                ),

                data.drawYLines(this.ctx, this.viewbox, data.yaxis
                    .filter((line) => data.valuebox.y + data.valuebox.height >= line.value && line.value >= data.valuebox.y)     
                    .map((line) => ({ y: data.toRatioY(line.value) })),
                    this.yGridColor
                ),

                data.drawCurve(
                    this.ctx,
                    this.viewbox, 
                    data.points.map((point) => ({ x: data.toRatioX(point.x), y: data.toRatioY(point.y) })).sort(by(get('x'))),
                    '#00bb55'
                )
            )
        }</canvas>

        <!-- SVG must be made to cover the available space else the shapes are not clickable in Safari -->
        <svg viewbox="$\{ data.rangebox[0] } $\{ data.rangebox[1] + data.rangebox[3] } $\{ data.rangebox[2] } $\{ -data.rangebox[3] }">
            <defs>
                <linearGradient id="handle-gradient" x1="0" x2="0" y1="0" y2="1">
                    <stop class="stop-1" offset="0%"/>
                    <stop class="stop-2" offset="100%"/>
                </linearGradient>

                <line part="$\{ data.part }" x1="$\{ data.x1 }" x2="$\{ data.x2 }" y1="$\{ data.y1 }"  y2="$\{ data.y2 }" id="line-def"></line>

                <circle part="handle" class="control control-handle control-point" cx="$\{ data.up.toViewX(data.point.x) }" cy="$\{ data.up.toViewY(data.point.y) }" r="0.5" data-index="$\{ data.index }" id="control-def">
                    <title>$\{data.point.label} $\{data.point.x && data.point.x.toFixed(2)}, $\{data.point.y && data.point.y.toFixed(2)}</title>
                </circle>
            </defs>

            <!--
            $\{ data.yaxis
            .filter((line) => data.valuebox.y + data.valuebox.height >= line.value && (
                data.yScale.startsWith('log') ? line.value === data.valuebox.y || line.value > data.valuebox.y && line.value >= ({
                    'logarithmic-24dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2,
                    'logarithmic-30dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2,
                    'logarithmic-36dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2,
                    'logarithmic-48dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2,
                    'logarithmic-60dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2/2/2,
                    'logarithmic-72dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2/2/2/2/2,
                    'logarithmic-96dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2
                })[data.yScale] :
                line.value >= data.valuebox.y
            ))    
            .map((line) => include(this.node.getRootNode().getElementById('line-def'), {
                part: 'y-line line',
                x1: data.toViewX(data.valuebox.x),
                x2: data.toViewX(data.valuebox.x + data.valuebox.width),
                y1: data.toViewY(line.value),
                y2: data.toViewY(line.value)
            })) }
            -->

            $\{ data.points.map((point, index) => include(this.node.getRootNode().getElementById('control-def'), {
                up: data,
                point,
                index
            })) }
        </svg>

        $\{ data.xaxis
        .filter((tick) => tick.label && data.valuebox.x + data.valuebox.width >= tick.value && tick.value >= data.valuebox.x)
        .map((tick, index) => include(this.node.getRootNode().getElementById('x-tick'), { up: data, tick })) }

        $\{ data.yaxis
        .filter((tick) => tick.label && data.valuebox.y + data.valuebox.height >= tick.value && (
            data.yScale.startsWith('log') ? tick.value === data.valuebox.y || tick.value > data.valuebox.y && tick.value >= ({
                'logarithmic-24dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2,
                'logarithmic-30dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2,
                'logarithmic-36dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2,
                'logarithmic-48dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2,
                'logarithmic-60dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2,
                'logarithmic-72dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2/2/2,
                'logarithmic-96dB': (data.valuebox.y + data.valuebox.height)/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2/2
            })[data.yScale] :
            tick.value >= data.valuebox.y
        ))   
        .map((tick, index) => include(this.node.getRootNode().getElementById('y-tick'), { up: data, tick })) }
    </template>
</head>

<body class="docs-grid grid 3x-grid @1-6x-grid @2-9x-grid">
    <nav class="x1 x-stretch y1 @2-x1 @2-1x">
        <a class="thumb thumb-1:1" width="400" height="400" style="background-image: url('../../images/logo.svg'); background-size: contain; width: 120%; padding-top: 120%; max-width: 6rem; margin-top: -16%; margin-left: -8%; margin-right: -12%;">Bolt</a>
    </nav>

    ${ include('../../templates/element.literal', comments("./module.js", "./shadow.css")) }

    <script type="module" src="./module.js"></script>

    ${ include('../../templates/scripts.html') }
    
    <script type="module">
    // Log events
    import events from '../../../dom/modules/events.js';
    events('input change', document)
    .each((e) => console.log(e.type, JSON.stringify(e.target.value)));
    </script>
</body>
